#!/bin/bash

#it's supposed to be more an alert to myself then any other thing
read -r -p "Did you followed the best practices before deploying? [y/n] --> " answer_best_practices

if [ "$answer_best_practices" == "y" ]; then

    current_branch=$(git symbolic-ref --short HEAD)

    if [ "$current_branch" == "master" ]; then

        read -r -p "Are you sure you wanna push directly to master branch? [y/n] --> " answer_current_branch

        if [ "$answer_current_branch" == "y" ]; then

            read -r -p "Commit message: " commit_message

            printf ">>> Deleting pycache, pyc and .idea files from: %s\n" "$current_branch"
            find . | grep -E "(__pycache__|\.pyc|\.idea$)" | xargs rm -rf

            printf ">>> Adding files from: %s\n" "$current_branch"
            git add .

            printf ">>> Commiting with message: %s\n" "$commit_message"
            git commit -m "$commit_message"

            printf ">>> Pushing branch: %s\n" "$current_branch"
            git push origin "$current_branch"

        else

            printf "Please create a new branch before continue.\n"

        fi

    else

        read -r -p "Commit message: " commit_message
        read -r -p "Branch to be merged: " branch_to_be_merged
        read -r -p "Current official dev branch: " branch_to_receive_merge

        printf ">>> Making sure I'm in the right branch: %s\n" "$branch_to_be_merged"
        git checkout "$branch_to_be_merged"

        printf ">>> Deleting pycache, pyc and .idea files from: %s\n" "$branch_to_be_merged"
        find . | grep -E "(__pycache__|\.pyc|\.idea$)" | xargs rm -rf

        printf ">>> Adding files from: %s\n" "$branch_to_be_merged"
        git add .

        printf ">>> Commiting with message: %s\n" "$commit_message"
        git commit -m "$commit_message"

        printf ">>> Changing to branch: %s\n" "$branch_to_receive_merge"
        git checkout "$branch_to_receive_merge"

        printf ">>> Merging %s with %s\n" "$branch_to_be_merged" "$branch_to_receive_merge"
        git merge "$branch_to_be_merged"

        printf ">>> Deleting pycache, pyc and .idea files from: %s\n" "$branch_to_receive_merge"
        find . | grep -E "(__pycache__|\.pyc|\.idea$)" | xargs rm -rf

        printf ">>> Pushing branch: %s\n" "$branch_to_receive_merge"
        git push origin "$branch_to_receive_merge"

    fi

elif [ "$answer_best_practices" == "n" ]; then

    printf "Please follow best practices.\nAborting...\n"

else

    printf "Wrong answer.\nPlease choose between y or n.\n"

fi